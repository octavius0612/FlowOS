name: Build iOS IPA (Unsigned - Surgical Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: üèó Setup Repo
        uses: actions/checkout@v3

      - name: üèó Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: üì¶ Install Dependencies
        run: |
          npm install
          npm install -g expo-cli

      - name: üöÄ Prebuild
        run: npx expo prebuild --platform ios

      - name: üíâ Surgical Injection in Podfile
        run: |
          cd ios
          # On utilise sed pour ins√©rer notre code DANS le bloc post_install existant
          # au lieu d'en cr√©er un nouveau qui causerait un conflit.
          sed -i '' '/post_install do |installer|/a\
            installer.pods_project.targets.each do |target|\
              target.build_configurations.each do |config|\
                config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"\
                config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"\
                config.build_settings["CODE_SIGNING_IDENTITY"] = ""\
                config.build_settings["EXPANDED_CODE_SIGN_IDENTITY"] = ""\
              end\
            end\
          ' Podfile

      - name: ü•• Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: üîì Force Disable Signing on Main Project
        run: |
          cd ios
          # D√©sactivation sur le projet principal
          find . -name "project.pbxproj" -print0 | xargs -0 sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g'
          find . -name "project.pbxproj" -print0 | xargs -0 sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g'
          find . -name "project.pbxproj" -print0 | xargs -0 sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g'

      - name: üî® Build App
        run: |
          cd ios
          xcodebuild -workspace FlowOS.xcworkspace \
            -scheme FlowOS \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            -destination 'generic/platform=iOS' \
            clean build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            -quiet

      - name: üì¶ Package IPA
        run: |
          mkdir Payload
          # R√©cup√©ration automatique du fichier .app
          APP_PATH=$(find ios/build -name "FlowOS.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Erreur: FlowOS.app non trouv√© !"
            exit 1
          fi
          cp -R "$APP_PATH" Payload/
          zip -r FlowOS.ipa Payload

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: flowos-ipa
          path: FlowOS.ipa
