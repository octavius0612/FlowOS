name: Build iOS IPA (Diagnostic Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: ðŸ— Setup Repo
        uses: actions/checkout@v3

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm install
          npm install -g expo-cli

      - name: ðŸš€ Prebuild
        run: npx expo prebuild --platform ios

      - name: ðŸ”“ Configure Ad-Hoc Signing
        run: |
          cd ios
          sed -i '' 's/CODE_SIGNING_ALLOWED = NO/CODE_SIGNING_ALLOWED = YES/g' FlowOS.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = NO/CODE_SIGNING_REQUIRED = YES/g' FlowOS.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "-";/g' FlowOS.xcodeproj/project.pbxproj

      - name: ðŸ¥¥ Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: ðŸ”¨ Build App & Capture Logs
        id: build_step
        run: |
          cd ios
          # On lance le build et on redirige la sortie vers un fichier log complet
          set -o pipefail
          xcodebuild -workspace FlowOS.xcworkspace \
            -scheme FlowOS \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            -destination 'generic/platform=iOS' \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES" \
            -allowProvisioningUpdates \
            | tee full_build.log

      - name: ðŸ“¦ Package IPA (Si succÃ¨s)
        if: success()
        run: |
          mkdir Payload
          mv ios/build/Build/Products/Release-iphoneos/FlowOS.app Payload/
          zip -r FlowOS.ipa Payload

      - name: ðŸ” Generate Error Report (Si Ã©chec)
        if: failure()
        run: |
          echo "=== RAPPORT D'ERREUR FLOW OS ===" > crash_report.txt
          echo "Date: $(date)" >> crash_report.txt
          echo "--------------------------------" >> crash_report.txt
          echo "" >> crash_report.txt
          
          echo ">>> ERREURS CRITIQUES :" >> crash_report.txt
          # On cherche les lignes contenant "error:" et on prend les 2 lignes d'avant et d'aprÃ¨s
          grep -C 2 "error:" ios/full_build.log >> crash_report.txt || echo "Pas d'erreur explicite 'error:' trouvÃ©e." >> crash_report.txt
          
          echo "" >> crash_report.txt
          echo ">>> Ã‰CHEC DU BUILD :" >> crash_report.txt
          grep "BUILD FAILED" ios/full_build.log >> crash_report.txt || echo "" >> crash_report.txt
          
          echo "" >> crash_report.txt
          echo ">>> PROBLÃˆMES DE SIGNATURE :" >> crash_report.txt
          grep "Signing" ios/full_build.log >> crash_report.txt || echo "" >> crash_report.txt

      - name: ðŸ“¤ Upload IPA (Si succÃ¨s)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: flowos-ipa
          path: FlowOS.ipa

      - name: ðŸ“¤ Upload Crash Report (Si Ã©chec)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ERROR-REPORT
          path: crash_report.txt
