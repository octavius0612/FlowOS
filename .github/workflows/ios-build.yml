name: Build iOS IPA (Fastlane + Diagnostics)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: ğŸ— Setup Repo
        uses: actions/checkout@v3

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install
          npm install -g expo-cli

      - name: ğŸš€ Prebuild
        run: npx expo prebuild --platform ios

      - name: ğŸ›  Setup Fastlane
        run: |
          cd ios
          mkdir -p fastlane
          # CrÃ©ation d'un fichier de config Fastlane qui force le mode non-signÃ©
          cat <<EOT > fastlane/Fastfile
          default_platform(:ios)
          platform :ios do
            desc "Build iOS App without signing"
            lane :build_unsigned do
              gym(
                scheme: "FlowOS",
                clean: true,
                output_directory: "./build",
                output_name: "FlowOS.ipa",
                export_method: "ad-hoc",
                skip_profile_detection: true,
                include_bitcode: false,
                include_symbols: false,
                export_options: {
                  signingStyle: "manual",
                  provisioningProfiles: {}
                },
                xcargs: "CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='' PROVISIONING_PROFILE_SPECIFIER=''"
              )
            end
          end
          EOT

      - name: ğŸ¥¥ Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: ğŸ”¨ Build with Fastlane & Capture Logs
        id: build_step
        run: |
          cd ios
          # On lance Fastlane et on enregistre TOUT dans un fichier log
          set -o pipefail
          bundle exec fastlane build_unsigned | tee fastlane_build.log

      # --- SECTION SUCCÃˆS ---
      
      - name: ğŸ“¦ Check IPA (Si succÃ¨s)
        if: success()
        run: |
          if [ ! -f "ios/build/FlowOS.ipa" ]; then
            echo "ERREUR: IPA non trouvÃ© malgrÃ© le succÃ¨s de Fastlane !"
            exit 1
          fi

      - name: ğŸ“¤ Upload IPA (Si succÃ¨s)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: flowos-ipa
          path: ios/build/FlowOS.ipa

      # --- SECTION DIAGNOSTIC (SI Ã‰CHEC) ---

      - name: ğŸ” Generate Error Report (Si Ã©chec)
        if: failure()
        run: |
          echo "=== RAPPORT D'ERREUR FASTLANE ===" > crash_report.txt
          echo "Date: $(date)" >> crash_report.txt
          echo "---------------------------------" >> crash_report.txt
          
          echo ">>> ERREURS CRITIQUES RELEVÃ‰ES :" >> crash_report.txt
          # On cherche les lignes contenant 'error' et on affiche un peu de contexte
          grep -iC 3 "error" ios/fastlane_build.log >> crash_report.txt || echo "Pas d'erreur explicite trouvÃ©e." >> crash_report.txt
          
          echo "" >> crash_report.txt
          echo ">>> LES 50 DERNIÃˆRES LIGNES DU LOG :" >> crash_report.txt
          tail -n 50 ios/fastlane_build.log >> crash_report.txt

      - name: ğŸ“¤ Upload Crash Report (Si Ã©chec)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ERROR-REPORT
          path: crash_report.txt


