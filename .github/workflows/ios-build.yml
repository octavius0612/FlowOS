name: Build iOS IPA (V28 - Clean Architecture)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: ğŸ— Setup Repo
        uses: actions/checkout@v3

      - name: ğŸ— Setup Node 20
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ§¹ Clean & Force Package.json
        run: |
          # On supprime tout ce qui pourrait causer des conflits
          rm -rf node_modules ios android .expo package-lock.json yarn.lock
          
          # ON Ã‰CRIT UN FICHIER DE CONFIGURATION NEUF ET PARFAIT
          # Cela force React 18.2.0 et React Native 0.74.5
          cat <<EOT > package.json
          {
            "name": "flowos",
            "version": "1.0.0",
            "main": "index.js",
            "scripts": {
              "start": "expo start",
              "android": "expo run:android",
              "ios": "expo run:ios",
              "web": "expo start --web"
            },
            "dependencies": {
              "expo": "^51.0.0",
              "react": "18.2.0",
              "react-native": "0.74.5",
              "react-native-reanimated": "~3.10.1",
              "react-native-gesture-handler": "~2.16.1",
              "react-native-safe-area-context": "4.10.5",
              "react-native-screens": "3.31.1",
              "expo-status-bar": "~1.12.1",
              "expo-linear-gradient": "~13.0.2",
              "expo-asset": "~10.0.10",
              "expo-font": "~12.0.9",
              "expo-constants": "~16.0.2",
              "expo-file-system": "~17.0.1",
              "@expo/vector-icons": "^14.0.0",
              "@google/generative-ai": "^0.1.3",
              "@react-native-async-storage/async-storage": "1.23.1"
            },
            "devDependencies": {
              "@babel/core": "^7.20.0",
              "@react-native-community/cli": "13.6.9",
              "@react-native-community/cli-platform-ios": "13.6.9",
              "metro-config": "^0.80.3",
              "@react-native/metro-config": "^0.74.87",
              "@expo/metro-config": "^0.18.11",
              "babel-preset-expo": "^11.0.0"
            },
            "private": true
          }
          EOT
          
          # On recrÃ©e les configs Babel et Metro
          echo "module.exports = function(api) { api.cache(true); return { presets: ['babel-preset-expo'], plugins: ['react-native-reanimated/plugin'], }; };" > babel.config.js
          echo "const { getDefaultConfig } = require('expo/metro-config'); const config = getDefaultConfig(__dirname); module.exports = config;" > metro.config.js
          
          # Config App.json
          cat <<EOT > app.json
          {
            "expo": {
              "name": "FlowOS",
              "slug": "flowos",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#ffffff"
              },
              "assetBundlePatterns": ["**/*"],
              "ios": {
                "supportsTablet": true,
                "bundleIdentifier": "com.flowos.final.v28"
              }
            }
          }
          EOT

      - name: ğŸ“¦ Install Dependencies (Clean)
        run: |
          npm install -g expo-cli
          # --legacy-peer-deps empÃªche npm de bloquer sur des avertissements mineurs
          npm install --legacy-peer-deps

      - name: ğŸš€ Prebuild
        run: npx expo prebuild --platform ios --clean

      - name: ğŸ“¦ Manual Bundle JS (Verification)
        run: |
          mkdir -p ios/assets
          npx react-native bundle \
            --entry-file index.js \
            --platform ios \
            --dev false \
            --bundle-output ios/main.jsbundle \
            --assets-dest ios \
            --reset-cache

      - name: ğŸ’‰ Disable Signing
        run: |
          cd ios
          sed -i '' '/post_install do |installer|/a\
            installer.pods_project.targets.each do |target|\
              target.build_configurations.each do |config|\
                config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"\
                config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"\
                config.build_settings["CODE_SIGNING_IDENTITY"] = ""\
                config.build_settings["EXPANDED_CODE_SIGN_IDENTITY"] = ""\
              end\
            end\
          ' Podfile
          
          find . -name "project.pbxproj" -print0 | xargs -0 sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g'
          find . -name "project.pbxproj" -print0 | xargs -0 sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g'

      - name: ğŸ¥¥ Install Pods
        run: |
          cd ios
          # On force la vieille architecture (stable)
          RCT_NEW_ARCH_ENABLED=0 pod install --repo-update

      - name: ğŸ”¨ Build Native App
        id: build_step
        run: |
          cd ios
          export SKIP_BUNDLING=1
          set -o pipefail
          xcodebuild \
            -workspace FlowOS.xcworkspace \
            -scheme FlowOS \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            -destination 'generic/platform=iOS' \
            clean build \
            CODE_SIGN_ENTITLEMENTS="" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            RCT_NEW_ARCH_ENABLED=0 \
            2>&1 | tee raw_build.log

      - name: ğŸ“¦ Package IPA
        if: success()
        run: |
          cd ios
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "CRITICAL FAILURE: .app not found."
            exit 1
          fi
          cp -R "$APP_PATH" Payload/
          zip -r FlowOS.ipa Payload

      - name: ğŸ“¤ Upload IPA
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: flowos-ipa
          path: ios/FlowOS.ipa

      - name: ğŸ” Debug Report
        if: failure()
        run: |
          echo "=== RAPPORT V28 ===" > crash_report.txt
          tail -n 100 ios/raw_build.log >> crash_report.txt || echo "Pas de log" >> crash_report.txt

      - name: ğŸ“¤ Upload Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ERROR-REPORT
          path: crash_report.txt
